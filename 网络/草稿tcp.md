# tcp可靠传输的实现



tcp连接

`tcp连接 ::= {socket1,socket2}={(ip1:port1),(ip2:port2)}`

tcp首部格式

20个字节固定，后面4n字节根据需要增加

* 源端口和目的端口 2+2

* 序号seq 4 发送的数据的第一个字节的序号

* 确认号 期望收到对方下一个报文段的第一个数据字节的序号 

  b收到a的报文段,序号501,数据长度是200，即(501-700) b在发送给a的确认报文段中确认号为701

* 数据偏移 4 数据距离tcp报文的起始点有多远，实际是指tcp的首部长度
* 保留 6
* 紧急URG (urgent)  URG=1时，说明紧急指针有效。该字段告诉发送方的tcp有紧急数据传输，于是发送方tcp就把紧急数据插入到本报文段数据的最前面
* 确认==ACK==(acknowledgment) 仅当ACK=1时确认号字段才有效
* 推送PSH(push) 很少使用
* 复位RST(reset) RST=1,说明TCP连接爆炸了
* 同步SYN(synchronization) 在建立连接时用来同步序号 SYN=1,ACK=0 说明是一个连接请求报文段 若对方同意，则在相应中 SYN=1 ACK=1    用于建立连接
* 终止FIN 释放连接
* 窗口 2 窗口指的是发送本报文段的一方的接收窗口(不是自己的发送窗口) `确认号`+`窗口值`=`发送方还可以接受多少数据`
* 校检和
* 紧急指针 指出本报文段紧急指针的字节数
* 选项 

  * MSS 最大报文段长度

A --> B

```mermaid
graph LR
A --> B
```

只讨论A向B发送数据 

A有一个窗口 发送窗口

B有一个窗口 接受窗口

A收到了B的数据，窗口是20，确认号是31  31-51   A构造出自己的窗口

![image-20190114220243272](https://ws1.sinaimg.cn/large/006tNc79gy1fz6goirg56j30p809qdrn.jpg)



==字节== `byte`       比特` bit`

  1byte=8bit





![image-20190114221639783](https://ws3.sinaimg.cn/large/006tNc79gy1fz6h2zbcwuj31d80mc4qp.jpg)







![image-20190114221303284](https://ws2.sinaimg.cn/large/006tNc79gy1fz6gz7t0v7j30pa0auahl.jpg)



### 5.7 tcp的流量控制

#### 5.7.1使用窗口控制流量



```sequence

participant A
participant B
B->A:建立连接后，B告诉A：我的接受窗口是rwnd(receiver window)=400,单位是字节(byte)
A->B :seq=1,DATA  
A->B :seq=101,DATA
A->B:seq=201,DATA 丢失
B->A:流量控制：ACK=1,ack=201,rwnd=300
A->B:seq=301,DATA
A->B:seq=401,DATA
A->B:seq=201,DATA
B->A:流量控制：ACK=1,ack=501,rwnd=100
A->B:seq=500,DATA
B->A:流量控制：ACK=1,ack=601,rwnd=0 接收窗口rwnd=0说明不能再发送数据了


```

英语解释

* rwnd: receiver window

* seq:序号 sequence

#### 5.7.2 tcp的传输效率

* 发送方不要发送过小的数据报
* 接口方不要在自己缓存很小时要数据报

算法实现：Nagle算法



### 5.8拥塞控制

#### 5.8.1拥塞控制的一般原理

资源：链路容量（带宽）、交换节点中的缓存和处理机等

拥塞： 对资源的需求 > 可用资源 时就会发生拥塞



##### 拥塞控制和流量控制区别

* 拥塞控制面向的对象是整个网络，是全局性的 ，流量控制面向的对象是发送方和接口方，是点对点的
* 举个例子：假设某个光纤网络的带宽是1000Gbit/s,一台巨型计算机向一台个人电脑以1 Gbit/s的速率传送小电影。显然带宽是够的，因此不会产生拥塞，但是流量控制却是必须的，因为巨型计算机经常要停下来，以便个人电脑来得及接受。  
* 但如果还有个网络，链路传输速率(带宽)为1Mbit/s,而有1000台大型计算机连接在这个网络上。假定其中的500台计算机分别向其余的500台计算机以100 kbit/s的速率发送文件。那么现在的问题就不是接受端的大型计算机是否来得及接受，而是整个网络的输入负载是否超过网络所能承受的。

#####拥塞控制所起的作用：



![image-20190115221129463](https://ws2.sinaimg.cn/large/006tNc79gy1fz7mjxbr37j30ow0c6k0x.jpg)

负载：单位时间内输入到网络的分组数目

吞吐量：单位时间从网络输出的分组数目

##### 理论上的拥塞控制方法

从大的方面看可以分为两种：开环控制和闭环控制

开环控制：在设计网络时就做好拥塞控制

闭环控制：基于反馈环路，哪里有拥塞，哪里有反馈